FROM quay.io/jupyter/datascience-notebook:python-3.11.9
#FROM jupyter/datascience-notebook:d53a302fbcd0

USER root
ENV DEBCONF_NOWARNINGS yes

# ãƒ™ãƒ¼ã‚¹OSãŒ Ubuntu Noble (24.04) ã§ã‚ã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ ã‚’ 'noble' ã«å›ºå®š
ARG DISTRO_CODENAME="noble"

# PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€MariaDBãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€Kerberosãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
# STEP 6: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‡¦ç† (findã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–)
RUN apt-get update \
    && apt-get install -y --no-install-recommends gnupg wget libmariadb-dev libkrb5-dev \
    \
    # PostgreSQL GPGã‚­ãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨é…ç½®
    && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/postgres-archive-keyring.gpg \
    \
    # APTã‚½ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«ãƒªãƒã‚¸ãƒˆãƒªã¨ç½²åæƒ…å ±ã‚’è¿½åŠ 
    && echo "deb [signed-by=/usr/share/keyrings/postgres-archive-keyring.gpg] http://apt.postgresql.org/pub/repos/apt ${DISTRO_CODENAME}-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
    \
    # ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ å¾Œã®æ›´æ–°
    && apt-get update \
    \
    # libpq-dev (PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    && apt-get install -y --no-install-recommends libpq-dev \
    \
    # ä¸è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    && apt-get remove -y gnupg wget \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* \
               /opt/julia-*/share/julia/stdlib/v*/SuiteSparse/.devcontainer/Dockerfile \
               /opt/julia/packages/Pluto/*/.vscode/ \
    \
    # findã‚³ãƒãƒ³ãƒ‰ãŒãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã®ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å¤–
    # u+s (Setuidãƒ“ãƒƒãƒˆ) ã®è§£é™¤
    && find / -path /proc -prune -o -path /sys -prune -o -path /dev -prune -o -path /run -prune -o \
        -type f -perm /u+s -ignore_readdir_race -exec chmod u-s {} \; \
    \
    # g+s (Setgidãƒ“ãƒƒãƒˆ) ã®è§£é™¤
    && find / -path /proc -prune -o -path /sys -prune -o -path /dev -prune -o -path /run -prune -o \
        -type f -perm /g+s -ignore_readdir_race -exec chmod g-s {} \; || true

#---

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒè¨­å®šã¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (STEP 7 to 12)
USER jovyan
WORKDIR /home/jovyan
COPY requirements.txt .
COPY Pipfile .
COPY Pipfile.lock .
COPY install.R .

# STEP 13: Python, Rã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ğŸ’¡ ä¿®æ­£æ¸ˆã¿: LD_PRELOAD ã®è¡ŒãŒæ­£ã—ãç¶™ç¶š/ã‚¯ã‚©ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
RUN pip install --no-cache-dir -r requirements.txt \
    && pipenv install --system \
    && LD_PRELOAD="/usr/lib/x86_64-linux-gnu/libssl.so:/usr/lib/x86_64-linux-gnu/libcrypto.so:/usr/lib/x86_64-linux-gnu/libgssapi_krb5.so" Rscript install.R || true \
    && rm -rf requirements.txt Pipfile* install.R .cache/R/pkgcache/sysreqs/docker/*/Dockerfile /tmp/* /var/tmp/* .npm/

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®è¨­å®š
HEALTHCHECK --interval=5s --retries=20 CMD ["curl", "-s", "-S", "-o", "/dev/null", "http://localhost:8888"]
